{"version":3,"file":"linker.js","sources":["../../src/linker/linker.ts"],"sourcesContent":["import { Node, mergeAttributes } from '@tiptap/core';\nimport { NodeSelection } from '@tiptap/pm/state';\n\n/* Our own model of a link in a rich document. */\nexport type LinkerAttributes = {\n  'href': string | null;\n  'target': '_blank' | null;\n  'title': string | null;\n  'data-id': string | null;\n  'data-app-prefix': string | null;\n};\n\ndeclare module '@tiptap/core' {\n  interface Commands<ReturnType> {\n    linker: {\n      /**\n       * Set a linker node\n       */\n      setLinker: (attributes: LinkerAttributes) => ReturnType;\n      /**\n       * Unset a linker node\n       */\n      unsetLinker: () => ReturnType;\n    };\n  }\n}\n\n/**\n * Internal links extension.\n * Reproduces the legacy angularJs \"linker\" directive.\n *\n * Links to internal resources MAY have a `title` and MUST HAVE `data-id` and `data-app-prefix` attributes :\n * `<a href=\"/blog#/view/35fa4198-blog_id/5e654c71-article_id\" data-app-prefix=\"blog\" data-id=\"35fa4198-blog_id\" target=\"_blank\" title=\"Voir ce billet de blog\" class=\"ng-scope\">/blog#/view/35fa4198-57fe-45eb-94f4-a5e4defff305/5e654c71-1e61-4f84-86dc-6fcfaf33f513</a>`\n */\nexport const Linker = Node.create({\n  name: 'linker',\n  content: 'text*',\n  marks: '',\n  group: 'inline',\n\n  inline: true,\n  selectable: true,\n  atom: true,\n  draggable: true,\n  isolating: true,\n  allowGapCursor: false,\n\n  priority: 1100,\n  keepOnSplit: false,\n\n  addOptions() {\n    return {\n      openOnClick: true,\n      HTMLAttributes: {\n        'target': null,\n        'title': null,\n        'class': null,\n        'data-id': null,\n        'data-app-prefix': null,\n      },\n      validate: undefined,\n    };\n  },\n\n  addAttributes() {\n    return {\n      'href': {\n        default: null,\n      },\n      'class': {\n        default: this.options.HTMLAttributes.class,\n      },\n      'target': {\n        default: this.options.HTMLAttributes.target,\n        // Sanitize target value\n        parseHTML: (element) =>\n          element.getAttribute('target') !== '_blank' ? null : '_blank',\n      },\n      'title': {\n        default: this.options.HTMLAttributes.title,\n      },\n      'data-id': {\n        default: this.options.HTMLAttributes['data-id'],\n      },\n      'data-app-prefix': {\n        default: this.options.HTMLAttributes['data-app-prefix'],\n      },\n    };\n  },\n\n  parseHTML() {\n    return [\n      {\n        tag: 'a[href]:not([href *= \"javascript:\" i])[data-id][data-app-prefix]',\n      },\n    ];\n  },\n\n  renderHTML({ HTMLAttributes }) {\n    if (HTMLAttributes.href?.startsWith('javascript:')) {\n      return [\n        'a',\n        mergeAttributes(this.options.HTMLAttributes, {\n          ...HTMLAttributes,\n          href: '',\n        }),\n        0,\n      ];\n    }\n    return [\n      'a',\n      mergeAttributes(this.options.HTMLAttributes, HTMLAttributes),\n      0,\n    ];\n  },\n\n  addCommands() {\n    return {\n      setLinker:\n        (attrs) =>\n        ({ commands }) => {\n          // Insert a Linker node with inner text node\n          commands.insertContent({\n            type: this.name,\n            attrs,\n            content: [\n              {\n                type: 'text',\n                text: attrs.title,\n              },\n            ],\n          });\n          return true;\n        },\n\n      unsetLinker:\n        () =>\n        ({ state, tr }) => {\n          // Which Linker node is actually selected ?\n          const { node, from, to } = state.selection as NodeSelection;\n          // Delete any selected Linker node\n          if (node?.type.name === 'linker') {\n            /* The following does not work as one would expected.\n            commands.deleteNode(this.name);\n            commands.deleteCurrentNode();\n            * Replaced by : */\n            tr.delete(from, to).scrollIntoView();\n          }\n          return true;\n        },\n    };\n  },\n});\n"],"names":[],"mappings":";AAkCa,MAAA,SAAS,KAAK,OAAO;AAAA,EAChC,MAAM;AAAA,EACN,SAAS;AAAA,EACT,OAAO;AAAA,EACP,OAAO;AAAA,EAEP,QAAQ;AAAA,EACR,YAAY;AAAA,EACZ,MAAM;AAAA,EACN,WAAW;AAAA,EACX,WAAW;AAAA,EACX,gBAAgB;AAAA,EAEhB,UAAU;AAAA,EACV,aAAa;AAAA,EAEb,aAAa;AACJ,WAAA;AAAA,MACL,aAAa;AAAA,MACb,gBAAgB;AAAA,QACd,QAAU;AAAA,QACV,OAAS;AAAA,QACT,OAAS;AAAA,QACT,WAAW;AAAA,QACX,mBAAmB;AAAA,MACrB;AAAA,MACA,UAAU;AAAA,IACZ;AAAA,EACF;AAAA,EAEA,gBAAgB;AACP,WAAA;AAAA,MACL,MAAQ;AAAA,QACN,SAAS;AAAA,MACX;AAAA,MACA,OAAS;AAAA,QACP,SAAS,KAAK,QAAQ,eAAe;AAAA,MACvC;AAAA,MACA,QAAU;AAAA,QACR,SAAS,KAAK,QAAQ,eAAe;AAAA;AAAA,QAErC,WAAW,CAAC,YACV,QAAQ,aAAa,QAAQ,MAAM,WAAW,OAAO;AAAA,MACzD;AAAA,MACA,OAAS;AAAA,QACP,SAAS,KAAK,QAAQ,eAAe;AAAA,MACvC;AAAA,MACA,WAAW;AAAA,QACT,SAAS,KAAK,QAAQ,eAAe,SAAS;AAAA,MAChD;AAAA,MACA,mBAAmB;AAAA,QACjB,SAAS,KAAK,QAAQ,eAAe,iBAAiB;AAAA,MAAA;AAAA,IAE1D;AAAA,EACF;AAAA,EAEA,YAAY;AACH,WAAA;AAAA,MACL;AAAA,QACE,KAAK;AAAA,MAAA;AAAA,IAET;AAAA,EACF;AAAA,EAEA,WAAW,EAAE,kBAAkB;;AAC7B,YAAI,oBAAe,SAAf,WAAqB,WAAW,iBAC3B;AAAA,MACL;AAAA,MACA,gBAAgB,KAAK,QAAQ,gBAAgB;AAAA,QAC3C,GAAG;AAAA,QACH,MAAM;AAAA,MAAA,CACP;AAAA,MACD;AAAA,IACF,IAEK;AAAA,MACL;AAAA,MACA,gBAAgB,KAAK,QAAQ,gBAAgB,cAAc;AAAA,MAC3D;AAAA,IACF;AAAA,EACF;AAAA,EAEA,cAAc;AACL,WAAA;AAAA,MACL,WACE,CAAC,UACD,CAAC,EAAE,gBAED,SAAS,cAAc;AAAA,QACrB,MAAM,KAAK;AAAA,QACX;AAAA,QACA,SAAS;AAAA,UACP;AAAA,YACE,MAAM;AAAA,YACN,MAAM,MAAM;AAAA,UAAA;AAAA,QACd;AAAA,MACF,CACD,GACM;AAAA,MAGX,aACE,MACA,CAAC,EAAE,OAAO,SAAS;AAEjB,cAAM,EAAE,MAAM,MAAM,OAAO,MAAM;AAE7B,gBAAA,6BAAM,KAAK,UAAS,YAKtB,GAAG,OAAO,MAAM,EAAE,EAAE,eAAe,GAE9B;AAAA,MAAA;AAAA,IAEb;AAAA,EAAA;AAEJ,CAAC;"}