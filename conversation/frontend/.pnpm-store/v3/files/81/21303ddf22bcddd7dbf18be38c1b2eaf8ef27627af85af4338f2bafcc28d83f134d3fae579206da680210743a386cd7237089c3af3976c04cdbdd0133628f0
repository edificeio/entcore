{"version":3,"file":"conversation-history.cjs","sources":["../../src/conversation-history/conversation-history.ts"],"sourcesContent":["import { mergeAttributes, Node } from '@tiptap/core';\nimport { Plugin } from 'prosemirror-state';\n\n/**\n * The `ConversationHistory` node is a custom ProseMirror node that represents a block-level\n * container for conversation history. It is implemented using the `@tiptap/core` library.\n *\n * @name ConversationHistory\n * @group block\n * @content block\n *\n * @parseHTML\n * This method defines how to parse the HTML representation of the node. It looks for a `div`\n * element with the class `conversation-history`.\n *\n * @renderHTML\n * This method defines how to render the node as HTML. It creates a `div` element with the class\n * `conversation-history`.\n *\n * @addProseMirrorPlugins\n * This method adds a ProseMirror plugin to the node. The plugin appends a transaction that groups\n * all nodes after a horizontal rule (`horizontalRule`) into a single `conversationHistory` node.\n *\n * @plugin\n * The plugin's `appendTransaction` method is called whenever a transaction is appended. It checks\n * for nodes after a horizontal rule and groups them into a `conversationHistory` node if any are\n * found.\n *\n * @param transactions - The list of transactions that have been applied.\n * @param oldState - The previous editor state.\n * @param newState - The new editor state.\n * @returns A new transaction if modifications were made, otherwise `null`.\n */\nexport const ConversationHistory = Node.create({\n  name: 'converstationHistory',\n  group: 'block',\n  content: 'block',\n\n  parseHTML() {\n    return [\n      {\n        tag: 'div.conversation-history',\n      },\n    ];\n  },\n\n  renderHTML({ HTMLAttributes }) {\n    return [\n      'div',\n      mergeAttributes(HTMLAttributes, { class: 'conversation-history' }),\n      0,\n    ];\n  },\n\n  /**\n   * Adds custom ProseMirror plugins to the editor.\n   * When a horizontal rule is encountered, this plugin collects all nodes\n   * following the horizontal rule until the end of the document.\n   * These nodes are then grouped together and replaced with\n   * a single node of the same type as the plugin's type.\n   *\n   * @returns {Plugin[]} An array of ProseMirror plugins.\n   */\n  addProseMirrorPlugins() {\n    return [\n      new Plugin({\n        appendTransaction: (transactions, oldState, newState) => {\n          const tr = newState.tr;\n          let modified = false;\n          const nodesAfterHr = [];\n\n          newState.doc.descendants((node, pos, parent) => {\n            if (\n              node.type.name === 'horizontalRule' &&\n              parent.type.name === 'doc'\n            ) {\n              const start = pos;\n              const end = newState.doc.content.size;\n\n              newState.doc.nodesBetween(start, end, (n, p, parent) => {\n                if (\n                  n.type.name !== 'horizontalRule' &&\n                  parent.type.name === 'doc'\n                ) {\n                  nodesAfterHr.push({ node: n, pos: p });\n                } else {\n                  return false;\n                }\n              });\n\n              if (nodesAfterHr.length > 0) {\n                const groupNode = this.type.create(\n                  {},\n                  nodesAfterHr.map((n) => n.node),\n                );\n                tr.replaceWith(start, end, groupNode);\n                modified = true;\n              }\n              return false;\n            }\n          });\n\n          return modified ? tr : null;\n        },\n      }),\n    ];\n  },\n});\n"],"names":["Node","mergeAttributes","Plugin","parent"],"mappings":"iKAiCa,oBAAsBA,UAAK,OAAO,CAC7C,KAAM,uBACN,MAAO,QACP,QAAS,QAET,WAAY,CACH,MAAA,CACL,CACE,IAAK,0BAAA,CAET,CACF,EAEA,WAAW,CAAE,gBAAkB,CACtB,MAAA,CACL,MACAC,KAAAA,gBAAgB,eAAgB,CAAE,MAAO,uBAAwB,EACjE,CACF,CACF,EAWA,uBAAwB,CACf,MAAA,CACL,IAAIC,wBAAO,CACT,kBAAmB,CAAC,aAAc,SAAU,WAAa,CACvD,MAAM,GAAK,SAAS,GACpB,IAAI,SAAW,GACf,MAAM,aAAe,CAAC,EAEtB,gBAAS,IAAI,YAAY,CAAC,KAAM,IAAK,SAAW,CAC9C,GACE,KAAK,KAAK,OAAS,kBACnB,OAAO,KAAK,OAAS,MACrB,CACA,MAAM,MAAQ,IACR,IAAM,SAAS,IAAI,QAAQ,KAa7B,GAXJ,SAAS,IAAI,aAAa,MAAO,IAAK,CAAC,EAAG,EAAGC,UAAW,CACtD,GACE,EAAE,KAAK,OAAS,kBAChBA,QAAO,KAAK,OAAS,MAErB,aAAa,KAAK,CAAE,KAAM,EAAG,IAAK,EAAG,MAE9B,OAAA,EACT,CACD,EAEG,aAAa,OAAS,EAAG,CACrB,MAAA,UAAY,KAAK,KAAK,OAC1B,CAAC,EACD,aAAa,IAAK,GAAM,EAAE,IAAI,CAChC,EACG,GAAA,YAAY,MAAO,IAAK,SAAS,EACzB,SAAA,EAAA,CAEN,MAAA,EAAA,CACT,CACD,EAEM,SAAW,GAAK,IAAA,CAE1B,CAAA,CACH,CAAA,CAEJ,CAAC"}