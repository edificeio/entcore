{"version":3,"file":"linker.cjs","sources":["../../src/linker/linker.ts"],"sourcesContent":["import { Node, mergeAttributes } from '@tiptap/core';\nimport { NodeSelection } from '@tiptap/pm/state';\n\n/* Our own model of a link in a rich document. */\nexport type LinkerAttributes = {\n  'href': string | null;\n  'target': '_blank' | null;\n  'title': string | null;\n  'data-id': string | null;\n  'data-app-prefix': string | null;\n};\n\ndeclare module '@tiptap/core' {\n  interface Commands<ReturnType> {\n    linker: {\n      /**\n       * Set a linker node\n       */\n      setLinker: (attributes: LinkerAttributes) => ReturnType;\n      /**\n       * Unset a linker node\n       */\n      unsetLinker: () => ReturnType;\n    };\n  }\n}\n\n/**\n * Internal links extension.\n * Reproduces the legacy angularJs \"linker\" directive.\n *\n * Links to internal resources MAY have a `title` and MUST HAVE `data-id` and `data-app-prefix` attributes :\n * `<a href=\"/blog#/view/35fa4198-blog_id/5e654c71-article_id\" data-app-prefix=\"blog\" data-id=\"35fa4198-blog_id\" target=\"_blank\" title=\"Voir ce billet de blog\" class=\"ng-scope\">/blog#/view/35fa4198-57fe-45eb-94f4-a5e4defff305/5e654c71-1e61-4f84-86dc-6fcfaf33f513</a>`\n */\nexport const Linker = Node.create({\n  name: 'linker',\n  content: 'text*',\n  marks: '',\n  group: 'inline',\n\n  inline: true,\n  selectable: true,\n  atom: true,\n  draggable: true,\n  isolating: true,\n  allowGapCursor: false,\n\n  priority: 1100,\n  keepOnSplit: false,\n\n  addOptions() {\n    return {\n      openOnClick: true,\n      HTMLAttributes: {\n        'target': null,\n        'title': null,\n        'class': null,\n        'data-id': null,\n        'data-app-prefix': null,\n      },\n      validate: undefined,\n    };\n  },\n\n  addAttributes() {\n    return {\n      'href': {\n        default: null,\n      },\n      'class': {\n        default: this.options.HTMLAttributes.class,\n      },\n      'target': {\n        default: this.options.HTMLAttributes.target,\n        // Sanitize target value\n        parseHTML: (element) =>\n          element.getAttribute('target') !== '_blank' ? null : '_blank',\n      },\n      'title': {\n        default: this.options.HTMLAttributes.title,\n      },\n      'data-id': {\n        default: this.options.HTMLAttributes['data-id'],\n      },\n      'data-app-prefix': {\n        default: this.options.HTMLAttributes['data-app-prefix'],\n      },\n    };\n  },\n\n  parseHTML() {\n    return [\n      {\n        tag: 'a[href]:not([href *= \"javascript:\" i])[data-id][data-app-prefix]',\n      },\n    ];\n  },\n\n  renderHTML({ HTMLAttributes }) {\n    if (HTMLAttributes.href?.startsWith('javascript:')) {\n      return [\n        'a',\n        mergeAttributes(this.options.HTMLAttributes, {\n          ...HTMLAttributes,\n          href: '',\n        }),\n        0,\n      ];\n    }\n    return [\n      'a',\n      mergeAttributes(this.options.HTMLAttributes, HTMLAttributes),\n      0,\n    ];\n  },\n\n  addCommands() {\n    return {\n      setLinker:\n        (attrs) =>\n        ({ commands }) => {\n          // Insert a Linker node with inner text node\n          commands.insertContent({\n            type: this.name,\n            attrs,\n            content: [\n              {\n                type: 'text',\n                text: attrs.title,\n              },\n            ],\n          });\n          return true;\n        },\n\n      unsetLinker:\n        () =>\n        ({ state, tr }) => {\n          // Which Linker node is actually selected ?\n          const { node, from, to } = state.selection as NodeSelection;\n          // Delete any selected Linker node\n          if (node?.type.name === 'linker') {\n            /* The following does not work as one would expected.\n            commands.deleteNode(this.name);\n            commands.deleteCurrentNode();\n            * Replaced by : */\n            tr.delete(from, to).scrollIntoView();\n          }\n          return true;\n        },\n    };\n  },\n});\n"],"names":["Node","mergeAttributes"],"mappings":"mHAkCa,OAASA,UAAK,OAAO,CAChC,KAAM,SACN,QAAS,QACT,MAAO,GACP,MAAO,SAEP,OAAQ,GACR,WAAY,GACZ,KAAM,GACN,UAAW,GACX,UAAW,GACX,eAAgB,GAEhB,SAAU,KACV,YAAa,GAEb,YAAa,CACJ,MAAA,CACL,YAAa,GACb,eAAgB,CACd,OAAU,KACV,MAAS,KACT,MAAS,KACT,UAAW,KACX,kBAAmB,IACrB,EACA,SAAU,MACZ,CACF,EAEA,eAAgB,CACP,MAAA,CACL,KAAQ,CACN,QAAS,IACX,EACA,MAAS,CACP,QAAS,KAAK,QAAQ,eAAe,KACvC,EACA,OAAU,CACR,QAAS,KAAK,QAAQ,eAAe,OAErC,UAAY,SACV,QAAQ,aAAa,QAAQ,IAAM,SAAW,KAAO,QACzD,EACA,MAAS,CACP,QAAS,KAAK,QAAQ,eAAe,KACvC,EACA,UAAW,CACT,QAAS,KAAK,QAAQ,eAAe,SAAS,CAChD,EACA,kBAAmB,CACjB,QAAS,KAAK,QAAQ,eAAe,iBAAiB,CAAA,CAE1D,CACF,EAEA,WAAY,CACH,MAAA,CACL,CACE,IAAK,kEAAA,CAET,CACF,EAEA,WAAW,CAAE,gBAAkB,QAC7B,OAAI,kBAAe,OAAf,SAAqB,WAAW,eAC3B,CACL,IACAC,qBAAgB,KAAK,QAAQ,eAAgB,CAC3C,GAAG,eACH,KAAM,EAAA,CACP,EACD,CACF,EAEK,CACL,IACAA,KAAAA,gBAAgB,KAAK,QAAQ,eAAgB,cAAc,EAC3D,CACF,CACF,EAEA,aAAc,CACL,MAAA,CACL,UACG,OACD,CAAC,CAAE,aAED,SAAS,cAAc,CACrB,KAAM,KAAK,KACX,MACA,QAAS,CACP,CACE,KAAM,OACN,KAAM,MAAM,KAAA,CACd,CACF,CACD,EACM,IAGX,YACE,IACA,CAAC,CAAE,MAAO,MAAS,CAEjB,KAAM,CAAE,KAAM,KAAM,IAAO,MAAM,UAE7B,OAAA,uBAAM,KAAK,QAAS,UAKtB,GAAG,OAAO,KAAM,EAAE,EAAE,eAAe,EAE9B,EAAA,CAEb,CAAA,CAEJ,CAAC"}